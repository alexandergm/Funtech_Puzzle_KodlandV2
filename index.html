<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–∞–∑–ª ‚Äî –†–∞–∫–µ—Ç–∞</title>

<style>
  html,body{
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    overflow:hidden;
    background:#eaf2ff;
    font-family:Arial, sans-serif;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  /* –í–µ—Å—å –∏–≥—Ä–æ–≤–æ–π –±–ª–æ–∫ */
  #game{
    width:1200px;   /* –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
    height:800px;
    position:absolute;
    transform-origin: top center; /* –∫–ª—é—á! */
  }

  h1{
    text-align:center;
    margin:20px 0 10px;
    font-size:32px;
  }

  #menu{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    margin-bottom:20px;
  }

  #wrap{
    position:relative;
    width:720px;
    height:480px;
    margin:auto;
    border:3px solid #1f2937;
    border-radius:12px;
    background:#cdd7ff;
    overflow:hidden;
  }

  #target{
    position:absolute;
    inset:0;
    background-size:100% 100%;
    opacity:0.12;
    pointer-events:none;
  }

  .piece{
    position:absolute;
    background-size:300% 300%;
    border:1px solid #222;
    border-radius:8px;
    cursor:grab;
    box-shadow:0 4px 10px rgba(0,0,0,.25);
    touch-action:none;
  }

  #msg{
    text-align:center;
    margin-top:20px;
    font-size:28px;
    font-weight:bold;
    color:#16a34a;
    display:none;
  }
</style>
</head>

<body>

<div id="game">

  <h1>–ü–∞–∑–ª ‚Äî –°–æ–±–µ—Ä–∏ —Ä–∞–∫–µ—Ç—É</h1>

  <div id="menu">
    <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:
      <select id="lvl">
        <option value="3">3√ó3</option>
        <option value="4">4√ó4</option>
        <option value="5">5√ó5</option>
      </select>
    </label>
    <button id="restart">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
  </div>

  <div id="wrap">
    <div id="target"></div>
  </div>

  <div id="msg">–£—Ä–∞! –†–∞–∫–µ—Ç–∞ —Å–æ–±—Ä–∞–Ω–∞ üéâ</div>

</div>

<script>
(() => {

  const BASE_W = 1200;
  const BASE_H = 800;
  const IMG = "rocket.png";     /* —Ç–≤–æ—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
  const SNAP = 30;

  const game = document.getElementById("game");
  const wrap = document.getElementById("wrap");
  const target = document.getElementById("target");
  const msg = document.getElementById("msg");
  const lvlSel = document.getElementById("lvl");
  const restartBtn = document.getElementById("restart");

  target.style.backgroundImage = `url(${IMG})`;

  let pieces = [];
  let N = 3;
  let currentScale = 1;

  restartBtn.onclick = init;
  lvlSel.onchange = init;

  /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
       –ê–î–ê–ü–¢–ò–í–ù–û–ï –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–ï –ü–û–î GENIALLY
  ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
  function scaleGame() {
      const sw = document.documentElement.clientWidth;
      const sh = document.documentElement.clientHeight;

      const scale = Math.min(sw / BASE_W, sh / BASE_H);
      currentScale = scale;

      game.style.transform = `translate(-50%, 0) scale(${scale})`;
      game.style.left = "50%";
      game.style.top = "0";
  }

  window.addEventListener("resize", scaleGame);
  window.addEventListener("load", scaleGame);

  /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
         –°–û–ó–î–ê–ù–ò–ï –ü–ê–ó–õ–ê
  ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
  function init(){
    msg.style.display = "none";
    pieces.forEach(p=>p.remove());
    pieces = [];

    N = parseInt(lvlSel.value,10);

    const W = wrap.clientWidth;
    const H = wrap.clientHeight;
    const pw = W / N;
    const ph = H / N;

    let coords = [];
    const margin = 25;
    const gap = 10;

    // —Å–Ω–∏–∑—É
    for(let i=0;i<N;i++){
      coords.push({ x: wrap.offsetLeft + i*(pw+gap), y: wrap.offsetTop + H + margin });
    }

    // —Å–ª–µ–≤–∞
    for(let i=0;i<N;i++){
      coords.push({ x: wrap.offsetLeft - pw - margin, y: wrap.offsetTop + i*(ph+gap) });
    }

    // —Å–ø—Ä–∞–≤–∞
    for(let i=0;i<N;i++){
      coords.push({ x: wrap.offsetLeft + W + margin, y: wrap.offsetTop + i*(ph+gap) });
    }

    coords.sort(()=>Math.random()-0.5);
    let posIndex = 0;

    for(let r=0; r<N; r++){
      for(let c=0; c<N; c++){
        const el = document.createElement("div");
        el.className = "piece";

        el.dataset.correctX = wrap.offsetLeft + c * pw;
        el.dataset.correctY = wrap.offsetTop  + r * ph;

        el.style.width = pw + "px";
        el.style.height = ph + "px";

        el.style.backgroundImage = `url(${IMG})`;
        el.style.backgroundSize = `${N*100}% ${N*100}%`;
        el.style.backgroundPosition = `${(c/(N-1))*100}% ${(r/(N-1))*100}%`;

        const pos = coords[posIndex++];
        el.style.left = pos.x + "px";
        el.style.top  = pos.y + "px";

        game.appendChild(el);
        pieces.push(el);

        enableDrag(el);
      }
    }
  }

  /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            DRAG + SCALE
  ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
  function enableDrag(el){
    let dragging = false;
    let ox=0, oy=0;

    function down(e){
      const p = (e.touches ? e.touches[0] : e);

      dragging = true;
      const rect = el.getBoundingClientRect();

      ox = (p.clientX - rect.left) / currentScale;
      oy = (p.clientY - rect.top)  / currentScale;

      el.style.zIndex = 200;

      window.addEventListener("mousemove", move);
      window.addEventListener("mouseup", up);
      window.addEventListener("touchmove", move, {passive:false});
      window.addEventListener("touchend", up);
    }

    function move(e){
      if(!dragging) return;
      e.preventDefault();

      const p = (e.touches ? e.touches[0] : e);
      const x = (p.clientX / currentScale) - ox;
      const y = (p.clientY / currentScale) - oy;

      el.style.left = x + "px";
      el.style.top  = y + "px";
    }

    function up(){
      dragging = false;
      snap(el);
      checkComplete();

      window.removeEventListener("mousemove", move);
      window.removeEventListener("mouseup", up);
      window.removeEventListener("touchmove", move);
      window.removeEventListener("touchend", up);
    }

    el.addEventListener("mousedown", down);
    el.addEventListener("touchstart", down, {passive:true});
  }

  /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
            –ü–†–ò–õ–ò–ü–ê–ù–ò–ï
  ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
  function snap(el){
    const cx = parseFloat(el.dataset.correctX);
    const cy = parseFloat(el.dataset.correctY);

    const x = parseFloat(el.style.left);
    const y = parseFloat(el.style.top);

    if(Math.abs(x - cx) < SNAP && Math.abs(y - cy) < SNAP){
      el.style.left = cx + "px";
      el.style.top  = cy + "px";
      el.dataset.locked = "1";
    } else {
      el.dataset.locked = "0";
    }
  }

  /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
         –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–´
  ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
  function checkComplete(){
    let ok = 0;

    for(const el of pieces){
      const cx = parseFloat(el.dataset.correctX);
      const cy = parseFloat(el.dataset.correctY);

      if(
        Math.abs(parseFloat(el.style.left) - cx) < 5 &&
        Math.abs(parseFloat(el.style.top)  - cy) < 5
      ){ ok++; }
    }

    if(ok === pieces.length){
      msg.style.display = "block";
    }
  }

  init();
  scaleGame();

})();
</script>

</body>
</html>
